<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLE Advertisement Scanner</title>
    <style>
        body { font-family: monospace; background: #000; color: #0f0; padding: 20px; }
        button { 
            background: #222; color: #0f0; border: 1px solid #0f0; 
            padding: 15px; width: 100%; font-size: 1.2rem;
        }
        .log-entry { 
            border-bottom: 1px solid #333; padding: 10px 0; font-size: 12px; 
            word-break: break-all;
        }
        .highlight { color: #fff; font-weight: bold; }
    </style>
</head>
<body>

    <button onclick="scanDevices()">1. SCAN STARTEN</button>
    <p id="status">Status: Bereit.</p>
    <div id="results"></div>

    <script>
        const resultsEl = document.getElementById('results');
        const statusEl = document.getElementById('status');

        async function scanDevices() {
            try {
                statusEl.innerText = "Status: Suche...";
                
                // Wir fragen nach dem Gerät. Das öffnet den Bluefy-Dialog.
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [0x181B, 0x1801, 0x180D] 
                });

                statusEl.innerText = "Status: Verbunden mit " + device.name;
                
                // Wir hängen den Listener VOR dem watchAdvertisements an
                device.addEventListener('advertisementreceived', (event) => {
                    renderData(event);
                });

                // Falls Bluefy watchAdvertisements doch irgendwie unterstützt:
                if (device.watchAdvertisements) {
                    await device.watchAdvertisements();
                    statusEl.innerText = "Status: Listening (watchAdvertisements)...";
                } else {
                    statusEl.innerText = "Status: Gerät gewählt, aber watchAds fehlt.";
                }

            } catch (error) {
                statusEl.innerText = "Fehler: " + error;
            }
        }

        function renderData(event) {
            let manufacturerString = "Keine Daten";
            
            if (event.manufacturerData) {
                manufacturerString = "";
                for (let [id, dataView] of event.manufacturerData) {
                    let hexId = id.toString(16).toUpperCase().padStart(4, '0');
                    let bytes = [];
                    for (let i = 0; i < dataView.byteLength; i++) {
                        bytes.push(dataView.getUint8(i).toString(16).toUpperCase().padStart(2, '0'));
                    }
                    manufacturerString += `ID: 0x${hexId} | Daten: ${bytes.join(' ')}<br>`;
                }
            }

            const html = `
                <div class="log-entry">
                    <span class="highlight">${new Date().toLocaleTimeString()}</span><br>
                    Name: ${event.name || 'Unbekannt'}<br>
                    RSSI: ${event.rssi}<br>
                    ${manufacturerString}
                </div>
            `;
            resultsEl.innerHTML = html + resultsEl.innerHTML;
        }
    </script>
</body>
</html>
